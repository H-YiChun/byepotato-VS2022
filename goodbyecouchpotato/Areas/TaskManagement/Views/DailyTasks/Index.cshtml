@model _SearchViewModel
@* 因為要使用在viewmodel的設定，所以這張文件所參考的Model屬性是_SearchViewModel，而不是原始的Model，這樣才可以引用viewmodel的東西
 *@
@using X.PagedList.Mvc.Core;
@using X.PagedList;
@using X.PagedList.Mvc.Core.Fluent

 <h1>每日任務管理</h1>
<div class="container">
    <div class="row">
        <hr />
    <div class="searcharea col-12 col-md-3">
        <h5>搜尋任務</h5>
        <form asp-controller="DailyTasks" asp-action="TaskSearch" id="Searchform">
            <div class="form-group">
            <label class="control-label" name="Name">@Html.DisplayNameFor(Model=>Model.TaskName)</label>
                <input type="text" asp-for="TaskName" class="form-control" autocomplete="off" placeholder="請填寫查詢內容"/>
            </div>
            <div class="form-group">
            <label class="control-label" name="Reward">@Html.DisplayNameFor(Model=>Model.Reward)</label>
                <input class="form-control" type="text" asp-for="Reward"   autocomplete="off" placeholder="請填寫完整數字"/>
            </div>
            <div class="form-group">
              <label class="control-label" >@Html.DisplayNameFor(Model=>Model.TaskActive)</label>
                <select id="Active" name="TaskActive" class="form-control">
                    <option value="">---請選擇---</option>
                    <option value="true">已啟用</option>
                    <option value="false">未啟用</option>
                </select>
            </div>
            <div class="form-group">
                <label class="control-label">@Html.DisplayNameFor(Model=>Model.TReviewStatus)</label>
                <select  class="form-control" id="reviewstatus" name="TReviewStatus">
                    <option value="">---請選擇---</option>
                    <option value="未通過">未通過</option>
                    <option value="通過">通過</option>
                    <option value="待複核">待複核</option>
                </select>
            </div>
    <hr />
        <p> <a class="btn btn-info col-12" asp-action="Create">新增任務</a></p>
        </form>
    </div>
    <div id="Tasklistarea" class=" col-12 col-md-9">
            <table class="table table-striped jambo_table bulk_action">
                <thead class="even pointer">
                    <tr class="odd pointer">
                    <td>@Html.DisplayNameFor(Model => Model.TaskName)</td>
                    <td>@Html.DisplayNameFor(Model => Model.Reward)</td>
                    <td>@Html.DisplayNameFor(Model => Model.TaskActive)</td>
                    <td>@Html.DisplayNameFor(Model => Model.TReviewStatus)</td>
                     @if (User.IsInRole("Admin"))
                      {
                         <td>操作介面</td>
                      }
                    
                </tr>
    </thead>
    <tbody class="list">

    </tbody>
        </table>

</div>
</div>
    </div>
@section Scripts{
        <script>

        $(document).ready(function () {
            let page = 1;
            $.ajax({
                url: "/TaskManagement/DailyTasks/IndexJson",  // 請求後端資料
                type: 'GET',
                data: { page: page },
                success: function (data) {
                    if (data && Array.isArray(data.data)) {
                        // 清空表格
                        $('table tbody').html('');

                        // 遍歷返回的數據並構建表格行
                        data.data.forEach(task => {
                            $('table tbody').append(`
                                        <tr>
                                            <td>${task.taskName}</td>
                                            <td>${task.reward}</td>
                                            <td>${task.taskActive === null ? "未知狀態" : (task.taskActive == true ? "已啟用" : "未啟用")}</td>
                                            <td>${task.tReviewStatus}</td>
                                            @if (User.IsInRole("Admin") || User.IsInRole("PermiGuard"))
                                            {
                                                <td><a class="btn btn-info" href="/TaskManagement/DailyTasks/Edit/${task.taskId}">編輯</a></td>
                                            }

                                        </tr>
                                    `);
                        });

                        // 更新分頁
                        updatePagination(data.currentpage, data.totalpages);
                    } else {
                        console.error('Expected an array of tasks.');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('An error occurred: ', error);
                }
            });
        });
            $('input').on('keyup', function () {
                $.ajax({
                    type:'POST',
                    url: "/TaskManagement/DailyTasks/TaskSearch",
                    data: $('#Searchform').serialize(),
                }).done(data => { $('.list').html(data); });
            })
            $('#Active').on('change', function () {
                    $.ajax({
                        type: 'POST',
                        url: "/TaskManagement/DailyTasks/TaskSearch",
                        data: $('#Searchform').serialize(),
                    }).done(data => { $('.list').html(data); });
                
            })
            $('#reviewstatus').on('change', function () {
                const reviewStatusValue = $('#reviewstatus').val();
                    $.ajax({
                        type: 'POST',
                        url: "/TaskManagement/DailyTasks/TaskSearch",
                        data: $('#Searchform').serialize(),
                    }).done(data => { $('.list').html(data); });
                
            })

        $(document).on('click', '.pagination .page-link', function (e) {
            e.preventDefault();

            let page = $(this).data('page'); // 获取目标页码
            if (page) {
                $.ajax({
                    type: 'POST',
                    url: "/TaskManagement/DailyTasks/TaskSearch",
                    data: $('#Searchform').serialize() + "&page=" + page,
                }).done(data => {
                    $('.list').html(data); // 更新部分视图
                    updatePagination(data.currentpage, data.totalpages); // 更新分页信息
                });
            }
        });
        </script>
}
